name: Claude Code Review Comment

on:
  workflow_run:
    workflows: ["Claude Code Review"]
    types:
      - completed

jobs:
  comment-screenshots:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.event == 'pull_request' }}
    permissions:
      contents: read
      pull-requests: write
      actions: read
      
    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });
            
            // PRãƒŠãƒ³ãƒãƒ¼ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆåã‹ã‚‰æŠ½å‡º
            const screenshotArtifact = artifacts.data.artifacts.find(artifact => 
              artifact.name.startsWith('playwright-screenshots-')
            );
            
            if (screenshotArtifact) {
              const prNumber = screenshotArtifact.name.split('-').pop();
              core.setOutput('number', prNumber);
              core.setOutput('artifact_id', screenshotArtifact.id);
              core.setOutput('artifact_name', screenshotArtifact.name);
              return prNumber;
            }
            return null;

      - name: Download artifacts
        if: steps.pr.outputs.number
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.pr.outputs.artifact_name }}
          path: ./screenshots
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate comment body
        if: steps.pr.outputs.number
        id: comment
        run: |
          echo "## ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ" > comment.md
          echo "" >> comment.md
          
          if [ -d "./screenshots" ] && [ "$(ls -A ./screenshots)" ]; then
            echo "Claude Codeã«ã‚ˆã‚‹å‹•ä½œç¢ºèªã§æ’®å½±ã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§ã™ï¼š" >> comment.md
            echo "" >> comment.md
            
            # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’ç”Ÿæˆ
            echo "### ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" >> comment.md
            echo "[ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})" >> comment.md
            echo "" >> comment.md
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º
            echo "### ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§" >> comment.md
            echo "" >> comment.md
            for file in ./screenshots/*; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                echo "- $filename" >> comment.md
              fi
            done
          else
            echo "ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚" >> comment.md
          fi
          
          echo "" >> comment.md
          echo "---" >> comment.md
          echo "_ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ by Claude Code Review workflow_" >> comment.md

      - name: Comment on PR
        if: steps.pr.outputs.number
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('comment.md', 'utf8');
            
            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }}
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ')
            );
            
            if (botComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ steps.pr.outputs.number }},
                body: comment
              });
            }